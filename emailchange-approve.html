<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Confirmar cambio de correo · SATV+</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="icon" href="images/satvpluslogo.png">
</head>

<body>
    <main class="container">
        <div class="panel" style="max-width:520px;margin:18px auto;">
            <h2 style="margin:0 0 8px 0;">Confirmar cambio de correo</h2>
            <p class="muted" style="margin:0 0 12px 0;">
                Estamos verificando tu acceso…
            </p>
            <div class="form-actions">
                <a class="btn ghost" href="/login.html">Volver</a>
            </div>
        </div>
    </main>

    <div class="toast-host" id="toast-host"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { toast } from "/js/ui.js";
        import { supabase } from "/js/supabaseClient.js";

        function parseHashParams() {
            const raw = window.location.hash?.startsWith("#") ? window.location.hash.slice(1) : "";
            return new URLSearchParams(raw);
        }

        async function ensureSessionFromUrl() {
            const url = new URL(window.location.href);
            const code = url.searchParams.get("code");

            if (code) {
                const { error } = await supabase.auth.exchangeCodeForSession(code);
                if (error) throw error;

                url.searchParams.delete("code");
                window.history.replaceState({}, "", url.toString());
            } else {
                await supabase.auth.getSession();
            }

            const { data } = await supabase.auth.getSession();
            return data.session;
        }

        try {
            const url = new URL(window.location.href);
            const uid = url.searchParams.get("uid");          // uuid del profiles.id
            const newEmail = url.searchParams.get("new");     // nuevo correo

            if (!uid || !newEmail) {
                toast("Link inválido. Volvé a iniciar el proceso.", "error");
                setTimeout(() => window.location.href = "/login.html", 1200);
                throw new Error("Missing uid/new");
            }

            const session = await ensureSessionFromUrl();
            if (!session?.user?.id) {
                toast("Link inválido o vencido. Volvé a iniciar el proceso.", "error");
                setTimeout(() => window.location.href = "/login.html", 1200);
                throw new Error("No session");
            }

            // ✅ Verificación fuerte: el uid del link debe ser el user logueado
            if (session.user.id !== uid) {
                toast("No coincide el usuario. Abrí el email correcto.", "error");
                setTimeout(() => window.location.href = "/login.html", 1400);
                throw new Error("UID mismatch");
            }

            const { error } = await supabase.auth.updateUser({ email: newEmail });
            if (error) throw error;

            toast("Te enviamos un email al correo nuevo para confirmar ✅", "success");
            setTimeout(() => window.location.href = "/login.html", 1500);
        } catch (err) {
            console.error(err);
            toast(err.message || "No se pudo completar el cambio", "error");
        }
    </script>
</body>

</html>